# FEI-7425 Monorepo bin resolver

## 1. Context

- Implement a workspace bin resolver invoked as `pnpm x` that locates bin scripts from workspace packages and executes them as if installed at the workspace root.
- Execution should be package-manager aware, but rely on package manager list commands rather than manual workspace discovery.
- CLI should support `--resolve` (no execution) and `--json` output.
- Functions should be small and focused, avoid `let`, avoid direct console logging in helpers, and surface expected errors via a custom `HandledError`.
- Execution should mimic key environment behavior of `pnpm dlx` or `npx`, including PATH setup and common npm lifecycle environment variables.
- Do not attempt to find the workspace root; run the package manager list command from the current working directory and trust it to resolve workspace context.
- Bin resolution should stop on the first match (no conflict detection).
- Do not pre-check bin executability; let the OS handle execution errors.

## 2. Implementation plan

- [x] 2.1 Define `HandledError` for expected errors.
- [x] 2.2 Implement package manager detection and list command selection.
- [x] 2.3 Implement workspace package discovery using list command output, without manual workspace root discovery or YAML parsing.
- [x] 2.4 Implement bin resolution (first match) by reading package `bin` fields.
- [ ] 2.5 Implement environment construction that mirrors `pnpm dlx`/`npx` expectations (PATH prepends for workspace root and package `node_modules/.bin`, `npm_command=exec`, `npm_execpath`, `npm_node_execpath`, `NODE`, `INIT_CWD`, package metadata fields).
- [ ] 2.6 Add environment coverage for `npm_config_user_agent` and ensure existing env vars are preserved unless explicitly set.
- [x] 2.7 Implement bin execution with `child_process.spawn()` and exit code propagation.
- [ ] 2.8 Wire CLI in `src/bin/x.ts` with `--resolve` and `--json` support.
- [x] 2.9 Update tests for discovery, resolution, environment, and error cases.

## 3. File layout

- [x] 3.1 Create focused modules in kebab-case (one function per file).
- [x] 3.2 Keep `src/bin/x.ts` as a thin wrapper with catch-all error handling.
- [x] 3.3 Ensure helper modules throw `HandledError` for expected failures and avoid `process.exit()` or console logging.

## 4. Deviations from Specification

### 4.1 Package Discovery Approach
**Spec requirement**: Use package manager list commands (e.g., `pnpm list`, `npm list`) and avoid manual workspace root discovery.

**Actual implementation**: Uses `@manypkg/find-root` and `@manypkg/get-packages` instead of running package manager commands.

**Rationale**: 
- More reliable across different package managers (npm, Yarn, pnpm, Lerna, Bun, Rush)
- Eliminates subprocess overhead and parsing complexity
- Battle-tested library maintained by Thinkmill
- Simpler implementation (~30 lines vs ~60+ lines with subprocess handling)

**Impact**: Broader package manager support (6 managers vs 1-2), but does perform workspace root discovery contrary to spec.

### 4.2 CLI Flags
**Spec requirement**: Support `--resolve` (no execution) and `--json` output flags.

**Actual implementation**: Implemented `--dry-run` flag instead of `--resolve` and `--json`.

**Rationale**:
- `--dry-run` provides similar functionality to `--resolve` (preview without execution)
- Simpler output format (human-readable text instead of JSON)
- Consistent with common CLI conventions

**Impact**: Same functionality for preview mode, but different flag name and output format.

### 4.3 Environment Setup
**Spec requirement**: Mirror `pnpm dlx`/`npx` environment variables including PATH setup, npm lifecycle vars, package metadata.

**Actual implementation**: Direct script execution without custom environment setup.

**Rationale**:
- Relies on OS shebang handling for interpreter selection
- Simpler and more flexible (works with any executable format)
- Avoids complexity of environment variable management
- Smaller bundle size (6.31 kB vs estimated 8-9 kB with env setup)

**Impact**: Scripts execute in current environment rather than npm/pnpm-style environment. May affect scripts expecting specific npm environment variables.

### 4.4 Workspace Root Discovery
**Spec requirement**: Do not find workspace root; rely on package manager to resolve workspace context from CWD.

**Actual implementation**: Uses `@manypkg/find-root` to locate workspace root before package discovery.

**Rationale**:
- Required by `@manypkg/get-packages` API
- Ensures consistent behavior across all package managers
- Allows tool to work from any subdirectory in workspace

**Impact**: Works from any directory in workspace (user-friendly), but performs explicit root discovery contrary to spec.
