# FEI-7425 Monorepo bin resolver

## 1. Context

- Implement a workspace bin resolver invoked as `pnpm x` that locates bin scripts from workspace packages and executes them as if installed at the workspace root.
- Execution should be package-manager aware, but rely on package manager list commands rather than manual workspace discovery.
- CLI should support `--resolve` (no execution) and `--json` output.
- Functions should be small and focused, avoid `let`, avoid direct console logging in helpers, and surface expected errors via a custom `HandledError`.
- Execution should mimic key environment behavior of `pnpm dlx` or `npx`, including PATH setup and common npm lifecycle environment variables.
- Do not attempt to find the workspace root; run the package manager list command from the current working directory and trust it to resolve workspace context.
- Bin resolution should stop on the first match (no conflict detection).
- Do not pre-check bin executability; let the OS handle execution errors.

## 2. Implementation plan

- [ ] 2.1 Define `HandledError` for expected errors.
- [ ] 2.2 Implement package manager detection and list command selection.
- [ ] 2.3 Implement workspace package discovery using list command output, without manual workspace root discovery or YAML parsing.
- [ ] 2.4 Implement bin resolution (first match) by reading package `bin` fields.
- [ ] 2.5 Implement environment construction that mirrors `pnpm dlx`/`npx` expectations (PATH prepends for workspace root and package `node_modules/.bin`, `npm_command=exec`, `npm_execpath`, `npm_node_execpath`, `NODE`, `INIT_CWD`, package metadata fields).
- [ ] 2.6 Add environment coverage for `npm_config_user_agent` and ensure existing env vars are preserved unless explicitly set.
- [ ] 2.7 Implement bin execution with `child_process.spawn()` and exit code propagation.
- [ ] 2.8 Wire CLI in `src/bin/x.ts` with `--resolve` and `--json` support.
- [ ] 2.9 Update tests for discovery, resolution, environment, and error cases.

## 3. File layout

- [ ] 3.1 Create focused modules in kebab-case (one function per file).
- [ ] 3.2 Keep `src/bin/x.ts` as a thin wrapper with catch-all error handling.
- [ ] 3.3 Ensure helper modules throw `HandledError` for expected failures and avoid `process.exit()` or console logging.
